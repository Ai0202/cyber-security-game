# 005: Stage 3 — フィッシング攻撃

## 概要

攻撃者として、ターゲットを騙すフィッシングメールを作成し、情報を窃取する体験を提供する。メーラー風UIでのフィッシングメール作成シミュレーション。

## 要件ソース

- docs/features.md#Stage 3: フィッシング攻撃
- docs/index.md#各ステージ共通レイアウト
- docs/openapi.yaml#/gemini/generate-scenario, /gemini/evaluate

## 既存実装の活用

| 流用元ブランチ | 内容 | 備考 |
|---------------|------|------|
| `feature/ransomware-chain-game` | `ReconPhase.jsx` のフィッシングメール作成部分 | メール作成UIとGemini評価の基本パターンあり。独立ステージとして大幅拡張 |

## タスク

### ゲームコンポーネント (`src/components/stages/phishing/`)

- [ ] `PhishingGame.tsx`: ゲーム全体の制御
  - ゲーム状態: 'briefing' | 'composing' | 'sent' | 'result'
  - Gemini API でターゲット情報取得
  - メール作成データの管理
  - 送信→ターゲット反応→スコア判定のフロー

- [ ] `TargetBriefing.tsx`: ミッションブリーフィング
  - ターゲットの企業情報、役職、最近の行動を表示
  - 「ミッション開始」ボタンでメール作成フェーズに遷移
  - ターミナル風のブリーフィングテキスト表示（TerminalText使用）

- [ ] `EmailComposer.tsx`: フィッシングメール作成フォーム
  - **送信者名 / メールアドレス**: なりすまし先を選択（上司、IT部門、銀行、配送業者等のプリセット + 自由入力）
  - **件名**: テキスト入力（緊急性・重要性のヒント表示あり）
  - **本文**: テンプレート選択 + カスタマイズ、または自由入力
  - **罠リンク / 添付ファイル**: 偽URL設定、偽添付ファイル名設定
  - プレビュー表示機能（実際のメーラー風の見た目でプレビュー）
  - 「送信」ボタンで評価フェーズへ

- [ ] `TargetReaction.tsx`: ターゲットの反応表示
  - Gemini API がストーリー形式で生成した反応を表示
  - 「リンクをクリックした」「不審に思って無視した」「IT部門に報告した」等
  - タイプライターエフェクトで段階的に表示
  - 反応に応じたリアクションアニメーション

### Gemini APIプロンプト (`src/lib/prompts/phishing.ts`)

- [ ] シナリオ生成プロンプト:
  - ターゲットの企業名・役職・部署・最近の行動パターンを生成
  - なりすまし先の選択肢（プリセット）を生成
  - メールテンプレート（3〜4種類: パスワード変更要求、請求書確認、配送通知等）を生成

- [ ] 評価プロンプト:
  - プレイヤーが作成したメールの「騙されやすさ」を多角的に評価
    - 送信者偽装の巧妙さ (0〜25pt)
    - 件名の緊急性・自然さ (0〜25pt)
    - 本文の説得力 (0〜30pt)
    - 罠URL/添付の巧妙さ (0〜20pt)
  - ターゲットのリアクションをストーリー形式で生成
  - 「このメールのどこが見破れるポイントだったか」の防御側フィードバックを生成

### モックデータ

- [ ] フォールバック用ハードコードシナリオ（ターゲット情報 + 固定評価パターン）

### ステージページ (`src/app/stage/phishing/page.tsx`)

- [ ] 共通レイアウト適用
- [ ] PhishingGame コンポーネントの配置
- [ ] メーラー風の全体UIデザイン（ダークテーマのメールクライアント風）

## 受け入れ条件

- Gemini APIでターゲット情報が動的生成されること
- メール作成フォームの全項目（送信者・件名・本文・罠リンク/添付）が入力可能なこと
- プレビュー機能で実際のメール表示イメージが確認できること
- 送信後にGemini APIがメールを多角的に評価し、4項目のスコアが返ること
- ターゲットの反応がストーリー形式で表示されること
- 合計スコアが0〜100の範囲で正しく計算されること
- モックモードで動作すること

## 備考

- メール本文の自由入力はテキストエリアで実装。リッチテキストエディタは不要（MVP）
- テンプレート選択 + カスタマイズの方が手軽にプレイできるので、テンプレート選択をデフォルトUIとする
