'use client';

import { useState, useEffect } from 'react';
import { motion, AnimatePresence } from 'framer-motion';
import type { GameComponentProps } from '@/lib/component-registry';
import CyberButton from '@/components/ui/CyberButton';
import NeonBadge from '@/components/ui/NeonBadge';

type Phase = 'loading' | 'briefing' | 'compose' | 'sending' | 'result';
interface Target { name: string; department: string; role: string; }

const disguiseMethods = [
  { id: 'double-ext', label: '二重拡張子 (.xlsx.exe)', desc: 'ファイル名を長くして拡張子を隠す' },
  { id: 'macro', label: 'マクロ付きOffice (.xlsm)', desc: 'マクロ実行で感染。開封率高い' },
  { id: 'zip-exe', label: 'ZIP圧縮 (.zip内に.exe)', desc: 'パスワード付きZIPでセキュリティ回避' },
  { id: 'lnk', label: 'ショートカット (.lnk)', desc: 'ショートカットファイルに偽装' },
];

const fallbackTarget: Target = { name: '鈴木', department: '経理部', role: '予算管理担当' };

export default function Access06MalwareAttachment({
  storyContext, phaseId, componentId, previousResults, onComplete,
}: GameComponentProps) {
  const [phase, setPhase] = useState<Phase>('loading');
  const [target, setTarget] = useState<Target>(fallbackTarget);
  const [fileName, setFileName] = useState('');
  const [disguise, setDisguise] = useState('macro');
  const [emailBody, setEmailBody] = useState('');
  const [emailSubject, setEmailSubject] = useState('');

  useEffect(() => {
    let cancelled = false;
    (async () => {
      try {
        const res = await fetch(`/api/game/phase/${phaseId}/action`, {
          method: 'POST', headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ componentId, action: 'init', storyContext, previousResults }),
        });
        if (!res.ok) throw new Error('API error');
        const data = await res.json();
        if (!cancelled && data.target) setTarget({ ...fallbackTarget, ...data.target });
      } catch { /* use fallback */ }
      if (!cancelled) setPhase('briefing');
    })();
    return () => { cancelled = true; };
  }, [storyContext, phaseId, componentId, previousResults]);

  const getFullFileName = () => {
    const base = fileName || '2024年度予算案';
    const m = disguiseMethods.find(d => d.id === disguise);
    if (disguise === 'double-ext') return `${base}.xlsx.exe`;
    if (disguise === 'macro') return `${base}.xlsm`;
    if (disguise === 'zip-exe') return `${base}.zip`;
    if (disguise === 'lnk') return `${base}.lnk`;
    return m ? `${base}` : base;
  };

  const handleSend = () => {
    setPhase('sending');
    setTimeout(() => {
      const breakdown = [];
      // File name believability (0-25)
      const budgetWords = ['予算', '決算', '報告', '請求', '見積', '給与', '経費'];
      const nameScore = budgetWords.some(w => fileName.includes(w)) ? 23 : fileName.length > 3 ? 15 : 6;
      breakdown.push({ category: 'ファイル名の信頼性', points: nameScore, maxPoints: 25, comment: nameScore >= 20 ? '業務関連のファイル名' : 'ファイル名の工夫が必要' });
      // Disguise method (0-25)
      const methodScores: Record<string, number> = { macro: 25, 'zip-exe': 22, 'double-ext': 15, lnk: 18 };
      const methodScore = methodScores[disguise] || 10;
      breakdown.push({ category: '偽装手法の効果', points: methodScore, maxPoints: 25, comment: disguiseMethods.find(d => d.id === disguise)?.desc || '' });
      // Email body (0-25)
      const bodyScore = emailBody.length > 50 ? 23 : emailBody.length > 20 ? 15 : 6;
      breakdown.push({ category: 'メール本文の説得力', points: bodyScore, maxPoints: 25, comment: bodyScore >= 20 ? '説得力のある本文' : '本文をもう少し具体的に' });
      // Overall realism (0-25)
      const subjectHasContext = emailSubject.includes('予算') || emailSubject.includes('確認') || emailSubject.includes('報告');
      const realismScore = (nameScore >= 20 && bodyScore >= 20 && subjectHasContext) ? 23 : (nameScore + bodyScore > 30) ? 16 : 8;
      breakdown.push({ category: '全体のリアリティ', points: realismScore, maxPoints: 25, comment: realismScore >= 20 ? '高い完成度' : '全体の整合性を改善' });
      const score = Math.min(100, Math.max(0, nameScore + methodScore + bodyScore + realismScore));
      const rank = score >= 90 ? 'S' : score >= 70 ? 'A' : score >= 50 ? 'B' : score >= 30 ? 'C' : 'D';
      setPhase('result');
      onComplete({ score, rank, breakdown, contextOutput: {
        malwareDeployed: score >= 50, infectedDevice: score >= 50 ? `${target.department}-PC01` : '',
        backdoorInstalled: score >= 70,
      }});
    }, 2000);
  };

  if (phase === 'loading') {
    return (
      <div className="flex min-h-[60vh] items-center justify-center">
        <motion.div animate={{ rotate: 360 }} transition={{ duration: 2, repeat: Infinity, ease: 'linear' }}
          className="mx-auto h-8 w-8 rounded-full border-2 border-cyber-cyan border-t-transparent" />
      </div>
    );
  }

  const inputCls = 'w-full rounded border border-white/10 bg-cyber-card px-3 py-2 font-mono text-sm text-white placeholder-gray-600 focus:border-cyber-green/50 focus:outline-none';

  return (
    <div className="mx-auto max-w-md px-4 py-6">
      <AnimatePresence mode="wait">
        {phase === 'briefing' && (
          <motion.div key="briefing" initial={{ opacity: 0 }} animate={{ opacity: 1 }} exit={{ opacity: 0 }}>
            <h2 className="mb-1 font-mono text-xs tracking-widest text-cyber-magenta">MALWARE ATTACHMENT</h2>
            <p className="mb-4 text-sm text-gray-400">マルウェアを仕込んだファイルを添付し、ターゲットのPCに感染させよ</p>
            <div className="mb-6 rounded-lg border border-white/10 bg-cyber-card p-4">
              <h3 className="mb-2 font-mono text-xs text-cyber-cyan">TARGET</h3>
              <p className="text-sm text-white">{target.department} {target.name}</p>
              <p className="text-xs text-gray-400">{target.role} - 日常的に予算関連の添付ファイルを開封</p>
            </div>
            <CyberButton onClick={() => setPhase('compose')} className="w-full">作成開始</CyberButton>
          </motion.div>
        )}
        {phase === 'compose' && (
          <motion.div key="compose" initial={{ opacity: 0 }} animate={{ opacity: 1 }} exit={{ opacity: 0 }}>
            <h2 className="mb-4 font-mono text-xs tracking-widest text-cyber-magenta">COMPOSE MALWARE EMAIL</h2>
            <div className="space-y-3">
              <div>
                <label className="mb-1 block font-mono text-xs text-gray-500">添付ファイル名</label>
                <input type="text" value={fileName} onChange={e => setFileName(e.target.value)} placeholder="例: 2024年度予算案" className={inputCls} />
                <p className="mt-1 font-mono text-xs text-gray-600">最終名: {getFullFileName()}</p>
              </div>
              <div>
                <label className="mb-2 block font-mono text-xs text-gray-500">偽装手法</label>
                <div className="space-y-2">
                  {disguiseMethods.map(m => (
                    <button key={m.id} onClick={() => setDisguise(m.id)}
                      className={`block w-full rounded border px-3 py-2 text-left ${disguise === m.id ? 'border-cyber-green bg-cyber-green/5' : 'border-white/10 bg-cyber-card'}`}>
                      <p className={`font-mono text-xs ${disguise === m.id ? 'text-cyber-green' : 'text-gray-400'}`}>{m.label}</p>
                      <p className="text-xs text-gray-600">{m.desc}</p>
                    </button>
                  ))}
                </div>
              </div>
              <div>
                <label className="mb-1 block font-mono text-xs text-gray-500">件名</label>
                <input type="text" value={emailSubject} onChange={e => setEmailSubject(e.target.value)} placeholder="例: 【確認依頼】2024年度予算案について" className={inputCls} />
              </div>
              <div>
                <label className="mb-1 block font-mono text-xs text-gray-500">メール本文</label>
                <textarea value={emailBody} onChange={e => setEmailBody(e.target.value)} rows={4} placeholder="添付ファイルの開封を促すメール本文..." className={inputCls} />
              </div>
            </div>
            <div className="mt-3 rounded border border-white/10 bg-black/30 p-3">
              <p className="font-mono text-xs text-gray-500">ATTACHMENT PREVIEW</p>
              <div className="mt-2 flex items-center gap-2">
                <span className="text-2xl">&#128206;</span>
                <span className="font-mono text-sm text-cyber-cyan">{getFullFileName()}</span>
              </div>
            </div>
            <div className="mt-4 flex gap-3">
              <CyberButton onClick={() => setPhase('briefing')} variant="secondary" className="flex-1">BACK</CyberButton>
              <CyberButton onClick={handleSend} variant="danger" className="flex-1" disabled={!fileName || !emailBody}>SEND</CyberButton>
            </div>
          </motion.div>
        )}
        {phase === 'sending' && (
          <motion.div key="sending" initial={{ opacity: 0 }} animate={{ opacity: 1 }} className="flex min-h-[60vh] items-center justify-center">
            <div className="text-center">
              <motion.div animate={{ rotate: 360 }} transition={{ duration: 2, repeat: Infinity, ease: 'linear' }}
                className="mx-auto mb-4 h-8 w-8 rounded-full border-2 border-cyber-magenta border-t-transparent" />
              <p className="font-mono text-sm text-cyber-magenta">DEPLOYING MALWARE...</p>
              <p className="mt-2 text-xs text-gray-500">ターゲットがファイルを開封するか監視中</p>
            </div>
          </motion.div>
        )}
        {phase === 'result' && (
          <motion.div key="result" initial={{ opacity: 0 }} animate={{ opacity: 1 }} className="flex min-h-[40vh] items-center justify-center">
            <div className="text-center">
              <NeonBadge color="green">PHASE COMPLETE</NeonBadge>
              <p className="mt-4 text-sm text-gray-400">結果を集計しています...</p>
            </div>
          </motion.div>
        )}
      </AnimatePresence>
    </div>
  );
}
